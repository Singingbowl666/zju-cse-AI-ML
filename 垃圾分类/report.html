<!DOCTYPE html><html><head>
      <title>report</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\61583\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.18\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h2 id="center-垃圾分类实验报告-center"><center> 垃圾分类实验报告 </center> </h2>
<h3 id="一-实验目的">一、实验目的 </h3>
<ul>
<li>了解并学习使用Mindspore深度学习框架</li>
<li>学习如何在预训练好的模型上进行微调</li>
<li>学习如何调整参数以提升深度模型精度</li>
</ul>
<h3 id="二-实验内容">二、实验内容 </h3>
<p>  深度学习计算中，从头开始训练一个实用的模型通常非常耗时，需要大量计算能力。常用的数据如OpenImage、ImageNet、VOC、COCO等公开大型数据集，规模达到几十万甚至超过上百万张。网络和开源社区上通常会提供这些数据集上预训练好的模型。大部分细分领域任务在训练网络模型时，如果不使用预训练模型而从头开始训练网络，不仅耗时，且模型容易陷入局部极小值和过拟合。因此大部分任务都会选择预训练模型，在其上做微调。<br>
  本实验我们基于Mindspore框架，在预训练的MobileNetV2模型上进行微调，实现垃圾分类任务，并通过参数调节提高分类精度。</p>
<h3 id="三-实现过程与具体代码">三、实现过程与具体代码 </h3>
<p>微调的时候需要先冻结backbone的参数，然后提取该层的特征作为Head的输入，这样可以加快训练速度。所以我首先将冻结层在训练集上做一遍推理，然后保存FeatureMap，作为修改层的数据集</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">extract_features</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> dataset_path<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>config<span class="token punctuation">.</span>features_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>config<span class="token punctuation">.</span>features_path<span class="token punctuation">)</span>
    dataset <span class="token operator">=</span> create_dataset<span class="token punctuation">(</span>config<span class="token operator">=</span>config<span class="token punctuation">)</span>
    step_size <span class="token operator">=</span> dataset<span class="token punctuation">.</span>get_dataset_size<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> step_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span>"The step_size of dataset <span class="token keyword keyword-is">is</span> zero<span class="token punctuation">.</span> Check <span class="token keyword keyword-if">if</span> the images count of train dataset <span class="token keyword keyword-is">is</span> more \
            than batch_size <span class="token keyword keyword-in">in</span> config<span class="token punctuation">.</span>py"<span class="token punctuation">)</span>

    data_iter <span class="token operator">=</span> dataset<span class="token punctuation">.</span>create_dict_iterator<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> data <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>
        features_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>features_path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"feature_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">.npy"</span></span><span class="token punctuation">)</span>
        label_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>features_path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"label_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">.npy"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>features_path<span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> <span class="token keyword keyword-not">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>label_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            image <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span>
            label <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span>
            features <span class="token operator">=</span> net<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
            np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>features_path<span class="token punctuation">,</span> features<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>label_path<span class="token punctuation">,</span> label<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Complete the batch </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>step_size<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>

backbone <span class="token operator">=</span> MobileNetV2Backbone<span class="token punctuation">(</span><span class="token punctuation">)</span>
load_checkpoint<span class="token punctuation">(</span>config<span class="token punctuation">.</span>pretrained_ckpt<span class="token punctuation">,</span> net<span class="token operator">=</span>backbone<span class="token punctuation">)</span>
extract_features<span class="token punctuation">(</span>backbone<span class="token punctuation">,</span> config<span class="token punctuation">.</span>dataset_path<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
</code></pre><p>接下来，我们定义需要训练的Head层网络</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">GlobalPooling</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Cell<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">'mean'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>GlobalPooling<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> reduction <span class="token operator">==</span> <span class="token string">'max'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>mean <span class="token operator">=</span> ms<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>ReduceMax<span class="token punctuation">(</span>keep_dims<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>mean <span class="token operator">=</span> ms<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>ReduceMean<span class="token punctuation">(</span>keep_dims<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> x


<span class="token keyword keyword-class">class</span> <span class="token class-name">MobileNetV2Head</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Cell<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_channel<span class="token operator">=</span><span class="token number">1280</span><span class="token punctuation">,</span> hw<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">'mean'</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">"None"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MobileNetV2Head<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>need_activation <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword keyword-if">if</span> reduction<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>flatten <span class="token operator">=</span> GlobalPooling<span class="token punctuation">(</span>reduction<span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>flatten <span class="token operator">=</span> nn<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
            input_channel <span class="token operator">=</span> input_channel <span class="token operator">*</span> hw <span class="token operator">*</span> hw
        self<span class="token punctuation">.</span>dense <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>input_channel<span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> weight_init<span class="token operator">=</span><span class="token string">'ones'</span><span class="token punctuation">,</span> has_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> activation <span class="token operator">==</span> <span class="token string">"Sigmoid"</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>activation <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-elif">elif</span> activation <span class="token operator">==</span> <span class="token string">"Softmax"</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>activation <span class="token operator">=</span> nn<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>need_activation <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">construct</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dense<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>need_activation<span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>activation<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> x
</code></pre><p>然后，我们在提取的特征集上训练Head层，首先冻结backbone的参数</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">train_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    train_dataset <span class="token operator">=</span> create_dataset<span class="token punctuation">(</span>config<span class="token operator">=</span>config<span class="token punctuation">)</span>
    eval_dataset <span class="token operator">=</span> create_dataset<span class="token punctuation">(</span>config<span class="token operator">=</span>config<span class="token punctuation">)</span>
    step_size <span class="token operator">=</span> train_dataset<span class="token punctuation">.</span>get_dataset_size<span class="token punctuation">(</span><span class="token punctuation">)</span>

    backbone <span class="token operator">=</span> MobileNetV2Backbone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Freeze parameters of backbone. You can comment these two lines.</span>
    <span class="token keyword keyword-for">for</span> param <span class="token keyword keyword-in">in</span> backbone<span class="token punctuation">.</span>get_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        param<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>
    load_checkpoint<span class="token punctuation">(</span>config<span class="token punctuation">.</span>pretrained_ckpt<span class="token punctuation">,</span> net<span class="token operator">=</span>backbone<span class="token punctuation">)</span>
</code></pre><p>接下来，我们定义网络结构，损失函数，优化器，训练网络</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    head <span class="token operator">=</span> MobileNetV2Head<span class="token punctuation">(</span>input_channel<span class="token operator">=</span>backbone<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span> num_classes<span class="token operator">=</span>config<span class="token punctuation">.</span>num_classes<span class="token punctuation">,</span> reduction<span class="token operator">=</span>config<span class="token punctuation">.</span>reduction<span class="token punctuation">)</span>
    network <span class="token operator">=</span> mobilenet_v2<span class="token punctuation">(</span>backbone<span class="token punctuation">,</span> head<span class="token punctuation">)</span>

    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>SoftmaxCrossEntropyWithLogits<span class="token punctuation">(</span>sparse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">'mean'</span><span class="token punctuation">)</span>
    lrs <span class="token operator">=</span> build_lr<span class="token punctuation">(</span>config<span class="token punctuation">.</span>epochs <span class="token operator">*</span> step_size<span class="token punctuation">,</span> lr_max<span class="token operator">=</span>config<span class="token punctuation">.</span>lr_max<span class="token punctuation">,</span> warmup_steps<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> decay_type<span class="token operator">=</span>config<span class="token punctuation">.</span>decay_type<span class="token punctuation">)</span>
    opt <span class="token operator">=</span> nn<span class="token punctuation">.</span>Momentum<span class="token punctuation">(</span>head<span class="token punctuation">.</span>trainable_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lrs<span class="token punctuation">,</span> config<span class="token punctuation">.</span>momentum<span class="token punctuation">,</span> config<span class="token punctuation">.</span>weight_decay<span class="token punctuation">)</span>
    net <span class="token operator">=</span> nn<span class="token punctuation">.</span>WithLossCell<span class="token punctuation">(</span>head<span class="token punctuation">,</span> loss<span class="token punctuation">)</span>
    train_step <span class="token operator">=</span> nn<span class="token punctuation">.</span>TrainOneStepCell<span class="token punctuation">(</span>net<span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
    train_step<span class="token punctuation">.</span>set_train<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>其中，损失函数我们采用交叉熵损失函数，优化器采用Momentum优化器，学习率采用自定义的学习率调度函数，即学习率随着训练步数的增加而减小，这样能防止训练后期模型产生震荡（我们共实现了两种学习率减小的方法：cosine decay和square decay，其中前者在后期逐渐衰减，而后者在训练前期就有较大衰减，相对均匀）</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">build_lr</span><span class="token punctuation">(</span>total_steps<span class="token punctuation">,</span> lr_init<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> lr_end<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> lr_max<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> warmup_steps<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> decay_type<span class="token operator">=</span><span class="token string">'cosine'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    lr_init<span class="token punctuation">,</span> lr_end<span class="token punctuation">,</span> lr_max <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>lr_init<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>lr_end<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>lr_max<span class="token punctuation">)</span>
    decay_steps <span class="token operator">=</span> total_steps <span class="token operator">-</span> warmup_steps
    lr_all_steps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    inc_per_step <span class="token operator">=</span> <span class="token punctuation">(</span>lr_max <span class="token operator">-</span> lr_init<span class="token punctuation">)</span> <span class="token operator">/</span> warmup_steps <span class="token keyword keyword-if">if</span> warmup_steps <span class="token keyword keyword-else">else</span> <span class="token number">0</span>
    <span class="token keyword keyword-for">for</span> i <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>total_steps<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> i <span class="token operator">&lt;</span> warmup_steps<span class="token punctuation">:</span>
            lr <span class="token operator">=</span> lr_init <span class="token operator">+</span> inc_per_step <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> decay_type <span class="token operator">==</span> <span class="token string">'cosine'</span><span class="token punctuation">:</span>
                cosine_decay <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>math<span class="token punctuation">.</span>pi <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> warmup_steps<span class="token punctuation">)</span> <span class="token operator">/</span> decay_steps<span class="token punctuation">)</span><span class="token punctuation">)</span>
                lr <span class="token operator">=</span> <span class="token punctuation">(</span>lr_max <span class="token operator">-</span> lr_end<span class="token punctuation">)</span> <span class="token operator">*</span> cosine_decay <span class="token operator">+</span> lr_end
            <span class="token keyword keyword-elif">elif</span> decay_type <span class="token operator">==</span> <span class="token string">'square'</span><span class="token punctuation">:</span>
                frac <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token builtin">float</span><span class="token punctuation">(</span>i <span class="token operator">-</span> warmup_steps<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>total_steps <span class="token operator">-</span> warmup_steps<span class="token punctuation">)</span>
                lr <span class="token operator">=</span> <span class="token punctuation">(</span>lr_max <span class="token operator">-</span> lr_end<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>frac <span class="token operator">*</span> frac<span class="token punctuation">)</span> <span class="token operator">+</span> lr_end
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                lr <span class="token operator">=</span> lr_max
        lr_all_steps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>lr<span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> lr_all_steps
</code></pre><p>接着开展 epochs 次训练，记录每次训练时长以及 loss 值，并将中间训练结果进行保存。</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># train</span>
history <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
features_path <span class="token operator">=</span> config<span class="token punctuation">.</span>features_path
idx_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>step_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword keyword-for">for</span> epoch <span class="token keyword keyword-in">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>idx_list<span class="token punctuation">)</span>
    epoch_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> j <span class="token keyword keyword-in">in</span> idx_list<span class="token punctuation">:</span>
        feature <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>features_path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"feature_</span><span class="token interpolation"><span class="token punctuation">{</span>j<span class="token punctuation">}</span></span><span class="token string">.npy"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>features_path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"label_</span><span class="token interpolation"><span class="token punctuation">{</span>j<span class="token punctuation">}</span></span><span class="token string">.npy"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_step<span class="token punctuation">(</span>feature<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    epoch_seconds <span class="token operator">=</span> <span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> epoch_start<span class="token punctuation">)</span>
    epoch_loss <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>losses<span class="token punctuation">)</span><span class="token punctuation">)</span>

    history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"epoch: {}, time cost: {}, avg loss: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epoch_seconds<span class="token punctuation">,</span> epoch_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> config<span class="token punctuation">.</span>save_ckpt_epochs <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        save_checkpoint<span class="token punctuation">(</span>network<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>config<span class="token punctuation">.</span>save_ckpt_path<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"mobilenetv2-</span><span class="token interpolation"><span class="token punctuation">{</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">.ckpt"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>可以每隔一个固定周期，在训练集上进行一次评估，实时跟踪中间训练模型在训练集上的准确率</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>    <span class="token comment"># evaluate</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">'validating the model...'</span><span class="token punctuation">)</span>
    eval_model <span class="token operator">=</span> Model<span class="token punctuation">(</span>network<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> metrics<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'acc'</span><span class="token punctuation">,</span> <span class="token string">'loss'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    acc <span class="token operator">=</span> eval_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>eval_dataset<span class="token punctuation">,</span> dataset_sink_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span>
</code></pre><p>由于保存时会保存所有ckpt模型，所以我们需要挑选出准确率最高的模型供测试时使用</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>acc_values <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token string">'acc'</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> item <span class="token keyword keyword-in">in</span> acc_list<span class="token punctuation">]</span>
CKPT <span class="token operator">=</span> acc_values<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>acc_values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span>acc_values<span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Max accuracy is "</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">(</span>acc_values<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Chosen checkpoint is "</span><span class="token punctuation">,</span> CKPT<span class="token punctuation">)</span>
</code></pre><p>最终做模型评估时，加载准确率最高的模型并对图像做处理，然后进行分类并测试准确率</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>backbone <span class="token operator">=</span> MobileNetV2Backbone<span class="token punctuation">(</span><span class="token punctuation">)</span>
head <span class="token operator">=</span> MobileNetV2Head<span class="token punctuation">(</span>input_channel<span class="token operator">=</span>backbone<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span> num_classes<span class="token operator">=</span>config<span class="token punctuation">.</span>num_classes<span class="token punctuation">,</span> reduction<span class="token operator">=</span>config<span class="token punctuation">.</span>reduction<span class="token punctuation">)</span>
network <span class="token operator">=</span> mobilenet_v2<span class="token punctuation">(</span>backbone<span class="token punctuation">,</span> head<span class="token punctuation">)</span>
model_path <span class="token operator">=</span> <span class="token string">'./results/opt_processing/mobilenetv2-28.ckpt'</span>
load_checkpoint<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> net<span class="token operator">=</span>network<span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">image_process</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">]</span>
    std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">]</span>
    image <span class="token operator">=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>image<span class="token punctuation">)</span> <span class="token operator">-</span> mean<span class="token punctuation">)</span> <span class="token operator">/</span> std
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    img_tensor <span class="token operator">=</span> Tensor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>image<span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> img_tensor

<span class="token keyword keyword-def">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>image<span class="token punctuation">,</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>image_height<span class="token punctuation">,</span> config<span class="token punctuation">.</span>image_width<span class="token punctuation">)</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> image_process<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    
    logits <span class="token operator">=</span> network<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    pred <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>logits<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    
    <span class="token keyword keyword-return">return</span> inverted<span class="token punctuation">[</span>pred<span class="token punctuation">]</span>
</code></pre><h3 id="四-参数调节与实验结果分析">四、参数调节与实验结果分析 </h3>
<div align="center">
<img src="image-4.png" width="80%">
</div>
经过大量的参数调节，最终模型在测试集的准确率接近97%，测试分数为96.92分，效果较好。以下着重分析调参的过程
<p>初次运行直接采用默认参数，在验证集上的精度为51.4%，测试得分也仅有52.3分，效果较差</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>config <span class="token operator">=</span> EasyDict<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"epochs"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
    <span class="token string">"lr_max"</span><span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
    <span class="token string">"decay_type"</span><span class="token punctuation">:</span> <span class="token string">'constant'</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
    <span class="token string">"momentum"</span><span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
    <span class="token string">"weight_decay"</span><span class="token punctuation">:</span> <span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>观察参数可以发现，epochs只有10次，模型可能还没有收敛，学习率并未采用动态下降方法，weight_decay的值也较大。因此我们可以通过增加epochs，采用cosine decay或square decay的学习率下降方法，增加momentum的值为0.9或0.99以及降低weight_decay的方法来提升精度。<br>
初步修改得到的参数如下：</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>config <span class="token operator">=</span> EasyDict<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"num_classes"</span><span class="token punctuation">:</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token comment"># 分类数，即输出层的维度</span>
    <span class="token string">"reduction"</span><span class="token punctuation">:</span> <span class="token string">'mean'</span><span class="token punctuation">,</span> <span class="token comment"># mean, max, Head部分池化采用的方式</span>
    <span class="token string">"image_height"</span><span class="token punctuation">:</span> <span class="token number">224</span><span class="token punctuation">,</span>
    <span class="token string">"image_width"</span><span class="token punctuation">:</span> <span class="token number">224</span><span class="token punctuation">,</span>
    <span class="token string">"batch_size"</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token comment"># 鉴于CPU容器性能，太大可能会导致训练卡住</span>
    <span class="token string">"eval_batch_size"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string">"epochs"</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
    <span class="token string">"lr_max"</span><span class="token punctuation">:</span> <span class="token number">0.03</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
    <span class="token string">"decay_type"</span><span class="token punctuation">:</span> <span class="token string">'cosine'</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
    <span class="token string">"momentum"</span><span class="token punctuation">:</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
    <span class="token string">"weight_decay"</span><span class="token punctuation">:</span> <span class="token number">4e-5</span><span class="token punctuation">,</span> <span class="token comment"># 请尝试修改以提升精度</span>
    <span class="token string">"dataset_path"</span><span class="token punctuation">:</span> <span class="token string">"./datasets/5fbdf571c06d3433df85ac65-momodel/garbage_26x100"</span><span class="token punctuation">,</span>
    <span class="token string">"features_path"</span><span class="token punctuation">:</span> <span class="token string">"./garbage_26x100_features"</span><span class="token punctuation">,</span> <span class="token comment"># 临时目录，保存冻结层Feature Map，可随时删除</span>
    <span class="token string">"class_index"</span><span class="token punctuation">:</span> index<span class="token punctuation">,</span>
    <span class="token string">"save_ckpt_epochs"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">"save_ckpt_path"</span><span class="token punctuation">:</span> <span class="token string">'./results/opt_processing'</span><span class="token punctuation">,</span>
    <span class="token string">"pretrained_ckpt"</span><span class="token punctuation">:</span> <span class="token string">'./src_mindspore/mobilenetv2-200_1067_cpu_gpu.ckpt'</span><span class="token punctuation">,</span>
    <span class="token string">"export_path"</span><span class="token punctuation">:</span> <span class="token string">'./results/mobilenetv2.mindir'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>训练得到的模型在验证集的准确率达到93.4%，但测试分数却只有77.69分</p>
<div align="center">
<img src="image-1.png" width="80%">
</div>
<p>之后我们尝试增加mometum为0.99，将学习率下降celve换为square decay，epochs增加到50，修改lr_max为0.1和0.01，测试得到的分数始终在73-78分之间，效果不佳。然后我们观察验证集发现，模型在验证集上的准确率始终在90%以上，但测试精度却不高，有两种可能会导致这种情况，一是模型过拟合，二是测试集和训练集的数据处理方式不同。</p>
<p>接着我们通过对代码的分析，发现了问题：</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>crop_decode_resize <span class="token operator">=</span> C<span class="token punctuation">.</span>RandomCropDecodeResize<span class="token punctuation">(</span>resize_height<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.08</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">1.333</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>在create_dataset函数中，decoder会将图片解码为RGB格式，而在测试函数中，PIL 读取的图片对象是BGR格式，因此我们需要将图片转换为RGB格式，这样才能保证测试集和训练集的数据处理方式一致。</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
</code></pre><p>修改后，在测试集上的分数达到91.54分</p>
<div align="center">
<img src="image-2.png" width="80%">
</div>
<p>在改正这个问题之后，我又尝试了对参数和优化器等进行修改：</p>
<p><strong>1. 增加epoch</strong> ：将epoch从40增加到60，80，100，发现模型在验证集上的准确率逐渐提升，最高达到96.34%，但在测试集上的得分却始终在90分左右徘徊，这可能是由于过大的epochs导致的学习到了训练集的特异化特征导致准确率有所下降</p>
<p><strong>2. 将优化器从Momentum改为Adam</strong> ：</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>opt <span class="token operator">=</span> nn<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>head<span class="token punctuation">.</span>trainable_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> learning_rate<span class="token operator">=</span>lrs<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>config<span class="token punctuation">.</span>weight_decay<span class="token punctuation">)</span>
</code></pre><p>训练得到的模型在验证集上的准确率达到96.6%，相较于之前的momentum有较大提升，测试集上的测试分数为92.24分，相较于原来变化不大。这说明模型的优化器选择对结果的影响很大，我们的优化方向也没有问题，只是受测试数据集的随机性影响导致分数没有提高，预期经过多次训练后是可以达到一个更高的测试分数的。</p>
<p><strong>3. 修改create_dataset函数</strong>：</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>crop_decode_resize <span class="token operator">=</span> C<span class="token punctuation">.</span>RandomCropDecodeResize<span class="token punctuation">(</span>resize_height<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.08</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">1.333</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
horizontal_flip_op <span class="token operator">=</span> C<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span>prob<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
color_adjust <span class="token operator">=</span> C<span class="token punctuation">.</span>RandomColorAdjust<span class="token punctuation">(</span>brightness<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> contrast<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> saturation<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>
</code></pre><p>create_dataset函数使用了RandomCropDecodeResize、RandomHorizontalFlip、RandomColorAdjust等函数对数据进行增强，这些函数会对数据进行随机裁剪、翻转和颜色调整等操作，以防止模型学习到训练集的特异化特征。<br>
同时，create_dataset函数还提供了一个repeat参数，用于扩充数据集，默认值为1。于是我尝试了提高repeat的值，以提升模型的泛化能力，不过训练的时间也会随之增加，最终得到的结果如下：</p>
<div align="center">
<img src="image-3.png" width="60%">
</div>
于是最终我们采用上述修改后的超参数和repeat = 8训练的模型，得到了96.92的测试分数，并将模型参数保存在result/best_models文件夹中。

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>